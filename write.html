<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mail 2 U - Write</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="./material3.css" />

    <!-- React & MUI Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@mui/material@5.16.1/umd/material-ui.development.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="./db.js"></script>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef } = React;
        const {
            createTheme, ThemeProvider, CssBaseline,
            Container, Box, Paper, Typography, TextField, Button,
            Stack, Chip, AppBar, Toolbar, IconButton, Fab,
            Dialog, DialogTitle, DialogContent, DialogContentText, DialogActions
        } = MaterialUI;

        const THEMES = [
            { id: 'indigo', color: '#6750A4', name: 'M3 Purple' }, // Primary M3 Color
            { id: 'purple', color: '#9c27b0', name: 'Purple' },
            { id: 'teal', color: '#00695f', name: 'Teal' }, // Darker Teal for M3 contrast
            { id: 'pink', color: '#b91d47', name: 'Pink' },
            { id: 'orange', color: '#d84e09', name: 'Orange' },
            { id: 'blueGrey', color: '#52667a', name: 'Slate' },
        ];

        function App() {
            const [form, setForm] = useState({
                subject: '', receiverName: '', receiverRole: '',
                senderName: '', senderRole: '', content: '',
                phone: '', email: '', driveLink: '', theme: 'indigo'
            });
            const [resultUrl, setResultUrl] = useState('');
            const qrRef = useRef();

            // Dynamic M3 Theme
            const theme = createTheme({
                typography: {
                    fontFamily: `'Roboto', 'Pretendard', sans-serif`,
                    h6: { fontWeight: 500 },
                    button: { textTransform: 'none', fontWeight: 500 }
                },
                palette: {
                    primary: { main: THEMES.find(t => t.id === form.theme)?.color || '#6750A4' },
                    background: { default: '#FEF7FF', paper: '#F7F2FA' }, // Surface Container
                    text: { primary: '#1D1B20', secondary: '#49454F' },
                },
                components: {
                    MuiTextField: {
                        defaultProps: { variant: 'filled', fullWidth: true, size: 'small' },
                        styleOverrides: {
                            root: {
                                '& .MuiFilledInput-root': {
                                    borderTopLeftRadius: 4, borderTopRightRadius: 4,
                                    backgroundColor: '#F3EDF7',
                                    '&:hover': { backgroundColor: '#EADDFF' },
                                    '&.Mui-focused': { backgroundColor: '#EADDFF' },
                                    '&:before': { borderBottom: '1px solid #49454F' },
                                    '&:after': { borderBottomWidth: 2 }
                                }
                            }
                        }
                    },
                    MuiPaper: {
                        defaultProps: { elevation: 0 },
                        styleOverrides: { root: { borderRadius: 16 } }
                    },
                    MuiButton: {
                        styleOverrides: {
                            root: { borderRadius: 20 },
                            contained: { boxShadow: 'none', '&:hover': { boxShadow: '0 1px 2px rgba(0,0,0,0.3)' } }
                        }
                    },
                    MuiDialog: {
                        styleOverrides: {
                            paper: { borderRadius: 28, padding: '16px' }
                        }
                    },
                    MuiChip: {
                        styleOverrides: {
                            root: { borderRadius: 8, fontWeight: 500 },
                            filled: { border: 'none' },
                            outlined: { borderColor: '#79747E' }
                        }
                    },
                    MuiAppBar: {
                        styleOverrides: {
                            root: { backgroundColor: '#FEF7FF', color: '#1D1B20', boxShadow: 'none' }
                        }
                    }
                }
            });

            const handleChange = (e) => setForm({ ...form, [e.target.name]: e.target.value });

            const handleSubmit = async () => {
                if (!form.subject) return alert('제목을 입력해주세요.');

                const id = await window.LetterDB.generateID(form);
                const finalData = { ...form, id, date: new Date().toLocaleDateString() };
                await window.LetterDB.save(finalData);

                const url = window.LetterDB.toUrl(finalData, 'view.html');
                setResultUrl(url);
                setTimeout(() => {
                    if (qrRef.current) QRCode.toCanvas(qrRef.current, url, { width: 200, margin: 2 });
                }, 100);
            };

            return (
                <ThemeProvider theme={theme}>
                    <CssBaseline />

                    <AppBar position="sticky">
                        <Toolbar>
                            <IconButton edge="start" onClick={() => window.location.href = 'index.html'} sx={{ mr: 1, color: 'onSurface' }}>
                                <span className="material-symbols-rounded">arrow_back</span>
                            </IconButton>
                            <Typography variant="h6" sx={{ flex: 1, color: '#1D1B20' }}>
                                새 편지
                            </Typography>
                            <Button onClick={handleSubmit} variant="contained" disableElevation sx={{ borderRadius: 20, px: 3 }}>
                                보내기
                            </Button>
                        </Toolbar>
                    </AppBar>

                    <Container maxWidth="md" sx={{ py: 4 }}>
                        <Paper sx={{ p: 4, bgcolor: '#F7F2FA' }}>
                            <Stack spacing={3}>
                                <Box>
                                    <Typography variant="body2" color="textSecondary" gutterBottom sx={{ fontWeight: 500, mb: 1 }}>
                                        테마 색상
                                    </Typography>
                                    <Stack direction="row" spacing={1} sx={{ overflowX: 'auto', pb: 1 }}>
                                        {THEMES.map(t => (
                                            <Chip
                                                key={t.id}
                                                label={t.name}
                                                onClick={() => setForm({ ...form, theme: t.id })}
                                                variant={form.theme === t.id ? "filled" : "outlined"}
                                                color={form.theme === t.id ? 'primary' : 'default'}
                                                icon={form.theme === t.id ? <span className="material-symbols-rounded" style={{ fontSize: 18 }}>check</span> : null}
                                                sx={{
                                                    '& .MuiChip-label': { px: 2 },
                                                    bgcolor: form.theme === t.id ? 'primary.container' : 'transparent',
                                                    color: form.theme === t.id ? 'onPrimaryContainer' : 'onSurfaceVariant',
                                                    borderColor: 'outline'
                                                }}
                                            />
                                        ))}
                                    </Stack>
                                </Box>

                                <Typography variant="h5" color="primary" sx={{ mb: 1, fontWeight: 400 }}>편지 내용</Typography>

                                <TextField label="제목" name="subject" value={form.subject} onChange={handleChange} required placeholder="제목을 입력하세요" />

                                <Stack direction={{ xs: 'column', sm: 'row' }} spacing={2}>
                                    <TextField label="받는사람 (이름)" name="receiverName" value={form.receiverName} onChange={handleChange} />
                                    <TextField label="받는사람 (직함/역할)" name="receiverRole" value={form.receiverRole} onChange={handleChange} />
                                </Stack>

                                <Stack direction={{ xs: 'column', sm: 'row' }} spacing={2}>
                                    <TextField label="보낸사람 (이름)" name="senderName" value={form.senderName} onChange={handleChange} />
                                    <TextField label="보낸사람 (직함/역할)" name="senderRole" value={form.senderRole} onChange={handleChange} />
                                </Stack>

                                <TextField
                                    label="내용" name="content"
                                    multiline rows={8}
                                    value={form.content} onChange={handleChange}
                                    placeholder="전하고 싶은 말을 적어보세요..."
                                />

                                <Typography variant="h5" color="secondary" sx={{ mb: 1, mt: 4, fontWeight: 400 }}>추가 정보</Typography>

                                <Stack direction={{ xs: 'column', sm: 'row' }} spacing={2}>
                                    <TextField label="전화번호 (선택)" name="phone" value={form.phone} onChange={handleChange} placeholder="예: 010-1234-5678" />
                                    <TextField label="이메일 (선택)" name="email" value={form.email} onChange={handleChange} placeholder="예: user@example.com" />
                                </Stack>
                                <TextField label="첨부파일 링크 (URL)" name="driveLink" value={form.driveLink} onChange={handleChange} placeholder="https://" />

                            </Stack>
                        </Paper>
                    </Container>

                    {/* Result Dialog */}
                    <Dialog open={!!resultUrl} onClose={() => setResultUrl('')} maxWidth="xs" fullWidth>
                        <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'center', p: 3 }}>
                            <span className="material-symbols-rounded" style={{ fontSize: 48, color: '#6750A4', marginBottom: 16 }}>qr_code_2</span>
                            <DialogTitle sx={{ p: 0, mb: 1 }}>작성 완료</DialogTitle>
                            <Typography variant="body2" color="text.secondary" align="center" sx={{ mb: 3 }}>
                                QR 코드를 스캔하거나 링크를 복사하세요.
                            </Typography>

                            <canvas ref={qrRef} style={{ borderRadius: 16, border: '1px solid #E0E0E0', marginBottom: 24 }} />

                            <Paper variant="outlined" sx={{
                                p: 2, width: '100%', bgcolor: '#F5F5F5', wordBreak: 'break-all',
                                display: 'flex', alignItems: 'center', mb: 3, borderColor: '#CAC4D0'
                            }}>
                                <Typography variant="caption" sx={{ flexGrow: 1, color: '#49454F' }}>
                                    {resultUrl}
                                </Typography>
                            </Paper>

                            <Stack direction="row" spacing={2} sx={{ width: '100%' }}>
                                <Button onClick={() => setResultUrl('')} fullWidth color="secondary" sx={{ borderRadius: 20 }}>닫기</Button>
                                <Button variant="contained" fullWidth onClick={() => { navigator.clipboard.writeText(resultUrl); alert('복사되었습니다!'); }} disableElevation sx={{ borderRadius: 20 }}>
                                    링크 복사
                                </Button>
                            </Stack>
                        </Box>
                    </Dialog>
                </ThemeProvider>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>