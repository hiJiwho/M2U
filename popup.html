<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Letter</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="./db.js"></script>
    <script src="./utils.js"></script>
    <link rel="stylesheet" href="./material3.css" />
    <style>
        :root {
            --G_white: #FFFFFF;
            --G_black: #000000;
            --G_gray_dark: #1D1B20;
            --G_gray_medium: #49454F;
            --G_gray_light: #E7E0EB;
            --G_divider: rgba(0, 0, 0, 0.12);

            /* Dynamic Theme Variables */
            --T_primary: #6750A4;
            --T_background: #FEF7FF;
            --T_surface: #FFFFFF;
            --T_surfaceContainer: rgba(103, 80, 164, 0.15);

            --L_primary: var(--T_primary);
            --L_container: var(--T_surfaceContainer);
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --T_surface: #141218;
                --T_background: #00000010;
                /* Slightly darker tint */
                --on-surface: #E6E1E5;
                --on-surface-variant: #CAC4D0;
                --outline-variant: #49454F;
            }
        }

        body {
            background-color: var(--T_background);
            padding: 40px 20px;
            margin: 0;
            display: flex;
            justify-content: center;
            font-family: 'Roboto', sans-serif;
            color: var(--G_gray_dark);
            transition: background-color 0.3s ease;
        }

        .letter-paper {
            width: 100%;
            max-width: 700px;
            background: var(--T_surfaceContainer);
            padding: 60px 80px;
            box-shadow: 0 4px 8px 3px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(0, 0, 0, 0.3);
            border-radius: 28px;
            position: relative;
            min-height: 85vh;
            color: #000000;
        }

        .header {
            font-size: 24px;
            font-weight: 500;
            /* M3 Headline Small */
            color: var(--on-surface);
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--outline-variant);
        }

        .content {
            font-size: 16px;
            color: var(--on-surface-variant);
            line-height: 1.6;
            min-height: 400px;
            white-space: pre-wrap;
            font-family: 'Roboto', 'Pretendard', sans-serif;
        }

        .content h1,
        .content h2,
        .content h3 {
            color: var(--theme-color);
            margin-top: 24px;
            font-weight: 500;
        }

        .footer {
            text-align: right;
            margin-top: 80px;
            padding-top: 20px;
            border-top: 1px solid var(--outline-variant);
        }

        .date {
            font-size: 14px;
            color: var(--on-surface-variant);
            margin-bottom: 8px;
        }

        .sender {
            font-size: 18px;
            font-weight: 500;
            color: var(--on-surface);
        }

        .theme-indicator {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            background: var(--T_surface);
            /* M3 Surface Container High/Low */
            color: var(--on-surface-variant);
            border: 1px solid var(--outline-variant);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .theme-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--L_primary);
        }

        @media screen and (max-width: 600px) {
            .letter-paper {
                padding: 40px 30px;
                border-radius: 16px;
            }
        }

        @media print {
            body {
                background: white;
            }

            .letter-paper {
                box-shadow: none;
                border: none;
                padding: 0;
            }

            .theme-indicator {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div id="root" style="width: 100%; display: flex; justify-content: center;">
        <div class="letter-paper">
            <div id="letter-header" class="header">로딩 중...</div>
            <div id="letter-content" class="content"></div>
            <div class="footer">
                <div id="letter-date" class="date"></div>
                <div id="letter-sender" class="sender"></div>
            </div>
        </div>
        <div id="theme-badge" class="theme-indicator">
            <div class="theme-dot"></div>
            <span id="theme-text">테마</span>
        </div>
    </div>

    <script>
        const THEME_COLORS = {
            m3_purple: '#6750A4',
            mint: '#008272',
            berry: '#0067C0', // Ocean Blue
            candy: '#E3008C',
            forest: '#004E4C',
            pumpkin: '#D83B01',
            zinc: '#505050'
        };

        const THEME_NAMES = {
            m3_purple: 'M3 퍼플',
            mint: '민트 틸',
            berry: '오션 블루',
            candy: '캔디 핑크',
            forest: '포레스트 그린',
            pumpkin: '펌킨 오렌지',
            zinc: '징크 그레이'
        };

        (async function () {
            const params = new URLSearchParams(window.location.search);
            const hasParams = params.has('subject') || params.has('content');

            let data = null;

            try {
                if (hasParams) {
                    // 1. From URL
                    data = window.LetterDB.fromUrl();
                    if (data) {
                        // Validation
                        // Logic shared with view.html, but implemented inline or helper fn?
                        // Implementing inline for now to avoid dependency on updated utils if not moved there.
                        const isRolling = data.messages && (typeof data.messages === 'string' ? data.messages.length > 2 : data.messages.length > 0);
                        if (!isRolling && !data.senderName) {
                            alert("URL이 완성되지 않았습니다. 보낸 사람께 문의 바랍니다.");
                            window.close();
                            return;
                        }

                        // 2. Auto-save (if not exists)
                        const exists = await window.LetterDB.exists(data.id);
                        if (!exists) {
                            // New Inbox Item
                            await window.LetterDB.save({ ...data, mailbox: ['inbox'], savedAt: new Date().toISOString() });
                        } else {
                            // Exists (Self-Send Case): Add 'inbox' tag if needed
                            const existing = await window.LetterDB.get(data.id);
                            if (existing) {
                                let mbox = existing.mailbox;
                                if (!Array.isArray(mbox)) mbox = [mbox]; // Normalize
                                if (!mbox.includes('inbox')) {
                                    mbox.push('inbox');
                                    await window.LetterDB.save({ ...existing, mailbox: mbox });
                                }
                            }
                        }
                    }

                    // 3. Session Save
                    sessionStorage.setItem('current_popup_letter', JSON.stringify(data));

                    // 4. URL Clean
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else {
                    // 1. From Session
                    const sessionStr = sessionStorage.getItem('current_popup_letter');
                    if (sessionStr) {
                        data = JSON.parse(sessionStr);
                    } else {
                        // Check Opener? (Optional)
                        try {
                            if (window.opener && window.opener.sessionStorage) {
                                const openerSession = window.opener.sessionStorage.getItem('current_letter');
                                if (openerSession) data = JSON.parse(openerSession);
                            }
                        } catch (e) { }

                        if (!data) {
                            alert('잘못된 접근입니다.');
                            window.close();
                            return;
                        }
                    }
                }
            } catch (e) {
                console.error("Critical Error during popup init:", e);
                alert("편지 로딩중 오류가 발생했습니다. 다음 로그를 참고해주세요\n" + e.message);
                return;
            }

            if (data) {
                // Apply Theme using CSS Variables
                const themeHex = THEME_COLORS[data.theme] || '#6750A4';
                const root = document.documentElement;
                root.style.setProperty('--T_primary', themeHex);
                root.style.setProperty('--T_background', themeHex + '08');
                root.style.setProperty('--T_surfaceContainer', themeHex + '15');

                // For direct accessibility if needed
                root.style.setProperty('--theme-color', themeHex);

                document.querySelector('.theme-dot').style.backgroundColor = themeHex;
                document.getElementById('theme-text').innerText = THEME_NAMES[data.theme] || 'M3 퍼플';

                //Header
                document.getElementById('letter-header').innerText = `받는이: ${data.receiverName} ${data.receiverRole}`;

                //Content or Rolling Paper
                const contentEl = document.getElementById('letter-content');

                if (data.messages) {
                    // Rolling Paper Mode
                    try {
                        const messages = JSON.parse(data.messages);

                        // Async process all messages for variables
                        Promise.all(messages.map(async msg => {
                            // Use VariableUtils if available, else fallback
                            const parsed = window.VariableUtils
                                ? await window.VariableUtils.parse(msg.content, { ...data, ...msg })
                                : msg.content;
                            return { ...msg, content: parsed };
                        })).then(processedMessages => {
                            let html = '<div style="display: flex; flex-direction: column; gap: 16px;">';
                            processedMessages.forEach(msg => {
                                html += `
                                    <div style="background: rgba(255,255,255,0.6); padding: 16px; border-radius: 16px; border: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                        <div style="display: flex; align-items: baseline; gap: 8px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 8px;">
                                            <span style="font-weight: 600; font-size: 1.1em; color: var(--theme-color);">${msg.senderName}</span>
                                            <span style="font-size: 0.85em; opacity: 0.7; color: #444;">${msg.senderRole}</span>
                                        </div>
                                        <div style="white-space: pre-wrap; line-height: 1.6; color: #333; font-size: 1.05em;">${msg.content}</div>
                                    </div>
                                `;
                            });
                            html += '</div>';
                            contentEl.innerHTML = html;
                        });

                    } catch (e) {
                        contentEl.innerText = "메시지를 불러오는 중 오류가 발생했습니다.";
                        console.error(e);
                    }
                } else {
                    // Normal Mode
                    const rawContent = data.content || '';
                    const promise = window.VariableUtils
                        ? window.VariableUtils.parse(rawContent, data)
                        : Promise.resolve(rawContent);

                    promise.then(parsed => {
                        if (window.marked) {
                            marked.setOptions({ breaks: true, gfm: true });
                            contentEl.innerHTML = marked.parse(parsed);
                        } else {
                            contentEl.innerText = parsed;
                        }
                    });
                }

                //Footer
                document.getElementById('letter-date').innerText = data.date;

                if (!data.messages) {
                    document.getElementById('letter-sender').innerText = `보낸이: ${data.senderName} ${data.senderRole}`;
                } else {
                    document.getElementById('letter-sender').innerText = data.senderName ? `보낸이: ${data.senderName}` : `롤링페이퍼 (${JSON.parse(data.messages).length}명)`;
                }

                // Auto-print if mode=print
                if (params.get('mode') === 'print') {
                    // Small delay to ensure rendering is complete
                    setTimeout(() => window.print(), 800);
                }
            }
        })();
    </script>
</body>

</html>