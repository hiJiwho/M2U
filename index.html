<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mail 2 U</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="./material3.css" />

    <!-- React & MUI Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@mui/material@5.16.1/umd/material-ui.development.js"
        crossorigin="anonymous"></script>
    <script src="./db.js"></script>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const {
            createTheme, ThemeProvider, CssBaseline,
            Box, Typography, Paper, Grid, Card, CardActionArea, CardContent, CardActions, Button, IconButton,
            Drawer, List, ListItem, ListItemButton, ListItemIcon, ListItemText,
            BottomNavigation, BottomNavigationAction, AppBar, Toolbar, Fab, useMediaQuery,
            Dialog, DialogTitle, DialogContent, DialogContentText, DialogActions
        } = MaterialUI;

        // Material Design 3 Theme
        const theme = createTheme({
            typography: {
                fontFamily: `'Roboto', 'Pretendard', sans-serif`,
                h6: { fontWeight: 500 },
                button: { textTransform: 'none', fontWeight: 500 }
            },
            palette: {
                mode: 'light',
                primary: { main: '#6750A4' },
                secondary: { main: '#625B71' },
                background: { default: '#FEF7FF', paper: '#F7F2FA' }, // Surface Container Low/High
                text: { primary: '#1D1B20', secondary: '#49454F' },
            },
            components: {
                MuiCard: {
                    styleOverrides: {
                        root: {
                            borderRadius: 16,
                            boxShadow: 'none',
                            backgroundColor: '#F3EDF7', // Surface Container
                            transition: 'background-color 0.2s',
                            '&:hover': { backgroundColor: '#EADDFF' }
                        }
                    }
                },
                MuiButton: {
                    styleOverrides: {
                        root: { borderRadius: 20 },
                        contained: { boxShadow: 'none', '&:hover': { boxShadow: '0 1px 2px rgba(0,0,0,0.3)' } }
                    }
                },
                MuiPaper: {
                    defaultProps: { elevation: 0 },
                    styleOverrides: {
                        root: { borderRadius: 16 }
                    }
                },
                MuiDrawer: {
                    styleOverrides: {
                        paper: {
                            borderTopRightRadius: 16, borderBottomRightRadius: 16,
                            border: 'none', backgroundColor: '#F7F2FA', margin: '12px', height: 'calc(100% - 24px)'
                        }
                    }
                },
                MuiListItemButton: {
                    styleOverrides: {
                        root: { borderRadius: 28, margin: '4px 8px', '&.Mui-selected': { backgroundColor: '#E8DEF8' } }
                    }
                },
                MuiAppBar: {
                    styleOverrides: {
                        root: { backgroundColor: '#FEF7FF', color: '#1D1B20', boxShadow: 'none' }
                    }
                }
            }
        });

        function App() {
            const isDesktop = useMediaQuery('(min-width:900px)');
            const [letters, setLetters] = useState([]);
            const [deleteId, setDeleteId] = useState(null);

            useEffect(() => { refresh(); }, []);
            const refresh = () => window.LetterDB.getAll().then(setLetters);

            const handleDelete = async () => {
                await window.LetterDB.delete(deleteId);
                setDeleteId(null);
                refresh();
            };

            const goWrite = () => window.location.href = 'write.html?mode=mui';
            const goRead = (l) => window.location.href = window.LetterDB.toUrl({ ...l, mode: 'mui' }, 'view.html');

            return (
                <ThemeProvider theme={theme}>
                    <CssBaseline />
                    <Box sx={{ display: 'flex', height: '100vh', flexDirection: isDesktop ? 'row' : 'column', bgcolor: 'background.default' }}>

                        {/* Desktop Navigation Rail / Drawer */}
                        {isDesktop && (
                            <Drawer variant="permanent" sx={{ width: 300, flexShrink: 0, '& .MuiDrawer-paper': { width: 300, boxSizing: 'border-box' } }}>
                                <Toolbar sx={{ pl: 3 }}>
                                    <span className="material-symbols-rounded" style={{ fontSize: 32, color: '#6750A4', marginRight: 12 }}>mail</span>
                                    <Typography variant="h6" color="onSurface" sx={{ fontWeight: 600 }}>
                                        Mail 2 U
                                    </Typography>
                                </Toolbar>
                                <Box sx={{ p: 2 }}>
                                    <Fab variant="extended" color="primary" sx={{ boxShadow: 'none', width: '100%', justifyContent: 'flex-start', pl: 3 }} onClick={goWrite}>
                                        <span className="material-symbols-rounded" style={{ marginRight: 12 }}>edit</span>
                                        Compose
                                    </Fab>
                                </Box>
                                <List sx={{ px: 1 }}>
                                    <ListItem disablePadding><ListItemButton selected><ListItemIcon><span className="material-symbols-rounded">inbox</span></ListItemIcon><ListItemText primary="받은 편지함" /></ListItemButton></ListItem>
                                    <ListItem disablePadding><ListItemButton><ListItemIcon><span className="material-symbols-rounded">star</span></ListItemIcon><ListItemText primary="즐겨찾기" /></ListItemButton></ListItem>
                                    <ListItem disablePadding><ListItemButton><ListItemIcon><span className="material-symbols-rounded">send</span></ListItemIcon><ListItemText primary="보낸 편지함" /></ListItemButton></ListItem>
                                </List>
                            </Drawer>
                        )}

                        {/* Mobile Header */}
                        {!isDesktop && (
                            <AppBar position="fixed">
                                <Toolbar>
                                    <Typography variant="h5" sx={{ flexGrow: 1, fontWeight: 500 }}>받은 편지함</Typography>
                                    <IconButton size="large" onClick={goWrite} sx={{ bgcolor: 'primary.container', color: 'onPrimaryContainer' }}>
                                        <span className="material-symbols-rounded">edit</span>
                                    </IconButton>
                                </Toolbar>
                            </AppBar>
                        )}

                        {/* Main Content */}
                        <Box component="main" sx={{ flexGrow: 1, p: { xs: 2, md: 3 }, pt: { xs: 10, md: 3 }, overflow: 'auto', pb: 10 }}>
                            {letters.length === 0 ? (
                                <Box sx={{ textAlign: 'center', mt: 10, opacity: 0.6 }}>
                                    <span className="material-symbols-rounded" style={{ fontSize: 64, color: 'var(--md-sys-color-outline)' }}>inbox</span>
                                    <Typography variant="body1">편지함이 비었습니다</Typography>
                                </Box>
                            ) : (
                                <Grid container spacing={2}>
                                    {letters.map(l => (
                                        <Grid item xs={12} sm={6} md={6} lg={4} key={l.id}>
                                            <Card>
                                                <CardActionArea onClick={() => goRead(l)} sx={{ p: 2, pb: 1 }}>
                                                    <Typography variant="h6" sx={{ fontSize: '1rem', fontWeight: 600, mb: 1 }}>
                                                        {l.subject || '제목 없음'}
                                                    </Typography>
                                                    <Box sx={{ display: 'flex', flexDirection: 'column', gap: 0.5 }}>
                                                        <Typography variant="body2" color="text.secondary">
                                                            보낸사람: {l.senderName}
                                                        </Typography>
                                                        <Typography variant="body2" color="text.secondary">
                                                            받는사람: {l.receiverName}
                                                        </Typography>
                                                    </Box>
                                                </CardActionArea>
                                                <CardActions sx={{ px: 2, pb: 2 }}>
                                                    {/* Action Buttons requested by user */}
                                                    {l.phone && (
                                                        <IconButton size="small" href={`tel:${l.phone}`} color="primary">
                                                            <span className="material-symbols-rounded">call</span>
                                                        </IconButton>
                                                    )}
                                                    {l.email && (
                                                        <IconButton size="small" href={`mailto:${l.email}`} color="primary">
                                                            <span className="material-symbols-rounded">email</span>
                                                        </IconButton>
                                                    )}

                                                    <Box sx={{ flexGrow: 1 }} />

                                                    <IconButton size="small" onClick={() => setDeleteId(l.id)}>
                                                        <span className="material-symbols-rounded">delete</span>
                                                    </IconButton>
                                                </CardActions>
                                            </Card>
                                        </Grid>
                                    ))}
                                </Grid>
                            )}
                        </Box>

                        {/* Delete Dialog */}
                        <Dialog open={!!deleteId} onClose={() => setDeleteId(null)} PaperProps={{ sx: { borderRadius: 7, p: 2 } }}>
                            <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'center', mb: 2 }}>
                                <span className="material-symbols-rounded" style={{ fontSize: 32, color: '#B3261E', marginBottom: 16 }}>delete</span>
                                <DialogTitle sx={{ p: 0 }}>편지를 삭제하시겠습니까?</DialogTitle>
                            </Box>
                            <DialogContent sx={{ textAlign: 'center' }}><DialogContentText>이 작업은 되돌릴 수 없습니다.</DialogContentText></DialogContent>
                            <DialogActions sx={{ justifyContent: 'center' }}>
                                <Button onClick={() => setDeleteId(null)} color="secondary">취소</Button>
                                <Button onClick={handleDelete} variant="contained" color="error" disableElevation>삭제</Button>
                            </DialogActions>
                        </Dialog>
                    </Box>
                </ThemeProvider>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>