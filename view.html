<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mail 2 U - Read</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="./material3.css" />
    <style>
        :root {
            --G_white: #FFFFFF;
            --G_black: #000000;
            --G_gray_dark: #1D1B20;
            --G_gray_medium: #49454F;
            --G_gray_light: #E7E0EB;
        }
    </style>

    <!-- React & MUI Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@mui/material@5.16.1/umd/material-ui.development.js"
        crossorigin="anonymous"></script>
    <script src="./db.js"></script>
    <script src="./utils.js"></script>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const MaterialUI = window.MaterialUI || window.Mui;
        const {
            createTheme, ThemeProvider, CssBaseline,
            Box, Typography, Paper, Button, Avatar, Stack, Chip, Divider, IconButton, Card, CardContent, CardActions, TextField
        } = MaterialUI;

        const THEMES = [
            { id: 'm3_purple', color: '#6750A4', name: 'M3 퍼플' },
            { id: 'mint', color: '#008272', name: '민트 틸' },
            { id: 'berry', color: '#0067C0', name: '오션 블루' },
            { id: 'candy', color: '#E3008C', name: '캔디 핑크' },
            { id: 'forest', color: '#004E4C', name: '포레스트 그린' },
            { id: 'pumpkin', color: '#D83B01', name: '펌킨 오렌지' },
            { id: 'zinc', color: '#505050', name: '징크 그레이' },
        ];

        function App() {
            const [data, setData] = useState(null);
            const [parsedContent, setParsedContent] = useState('');
            const [parsedMessages, setParsedMessages] = useState([]);
            const [isLocked, setIsLocked] = useState(false);
            const [passwordInput, setPasswordInput] = useState('');

            useEffect(() => {
                const init = async () => {
                    try {
                        const params = new URLSearchParams(window.location.search);
                        const hasParams = params.has('subject') || params.has('content');

                        let d = null;

                        if (hasParams) {
                            d = window.LetterDB.fromUrl();
                            if (d) {
                                // Validation
                                const errorMsg = validateData(d);
                                if (errorMsg) {
                                    alert(errorMsg);
                                    window.location.href = 'index.html'; // Or stay to show error? Stay may be better but 'no data' state needs handling.
                                    return;
                                }

                                // Only save to inbox if it doesn't already exist to avoid duplicate entries for sent letters
                                const exists = await window.LetterDB.exists(d.id);
                                if (!exists) {
                                    await window.LetterDB.save({ ...d, mailbox: 'inbox', savedAt: new Date().toISOString() });
                                }
                                sessionStorage.setItem('current_letter', JSON.stringify(d));
                                const cleanUrl = window.location.pathname;
                                window.history.replaceState({}, document.title, cleanUrl);
                            }
                        } else {
                            const sessionData = sessionStorage.getItem('current_letter');
                            if (sessionData) {
                                d = JSON.parse(sessionData);
                            } else {
                                alert('유효하지 않은 접근입니다. 메인으로 이동합니다.');
                                window.location.href = 'index.html';
                                return;
                            }
                        }

                        if (d) {
                            // Re-validate session data just in case
                            const errorMsg = validateData(d);
                            if (errorMsg) {
                                alert(errorMsg);
                                return;
                            }

                            setData(d);
                            if (d.passwordHash) {
                                setIsLocked(true);
                            } else {
                                parseData(d);
                            }
                        }
                    } catch (e) {
                        console.error("Critical Error during init:", e);
                        alert("편지 로딩중 오류가 발생했습니다. 다음 로그를 참고해주세요\n" + e.message);
                    }
                };
                init();
            }, []);

            const validateData = (d) => {
                // Check required fields
                // Required: senderName (or messages for rolling paper), receiverName? (receiverName is used in header)
                // User req: Sender Name, Sender Role, Phone, Email, File URL, Password ?
                // "Did not have some string (W.O. Sender, sender's 역활, phone num, Email, file URL, Password)"
                // This implies these fields CAN be empty but the URL structure itself might be malformed if keys are missing?
                // The prompt says: "if that share URL Did not have some string... show error 'URL이 완성되지 않았습니다...'"
                // It specifically mentions "W.O. Sender...". W.O likely means "WithOut"?
                // Let's assume validation means checking if the essential data that makes the letter valid is present.
                // The prompt lists: Sender, Role, Phone, Email, File, PW.
                // But not all letters have all these. Maybe it means if the *URL param keys* are missing completely?
                // window.LetterDB.fromUrl() returns keys with empty strings if missing.
                // Re-reading: "URL params have keys but empty values?" -> No, `fromUrl` fills defaults.

                // Let's interpret "URL이 완성되지 않았습니다" as generic "Required fields missing".
                // What is absolutely required? SenderName is critical.

                // Special case: Rolling paper (has messages), might not have single senderName.
                const isRolling = d.messages && (typeof d.messages === 'string' ? d.messages.length > 2 : d.messages.length > 0);

                if (!isRolling && !d.senderName) {
                    return "URL이 완성되지 않았습니다. 보낸 사람께 문의 바랍니다.";
                }

                // The user listed "Sender, sender's 역활, phone num, Email, file URL, Password".
                // It sounds like if ANY of these are corrupted or the URL truncated?
                // But optional fields like phone/email can be empty.
                // I'll assume SenderName is the primary check for "Completion". 
                // If it's a specific "Template" that requires them, that's different.
                // Given "M2U" context, only Sender/Receiver names are truly visible and needed.

                return null;
            };

            const parseData = (d) => {
                if (window.VariableUtils) {
                    window.VariableUtils.parse(d.content, d).then(setParsedContent);
                    if (d.messages) {
                        try {
                            const msgs = JSON.parse(d.messages);
                            Promise.all(msgs.map(async m => ({
                                ...m,
                                content: await window.VariableUtils.parse(m.content, { ...d, ...m })
                            }))).then(setParsedMessages);
                        } catch (e) { console.error(e); }
                    }
                } else {
                    setParsedContent(d.content);
                }
            };

            const unlock = async () => {
                const hash = await window.LetterDB.hashPassword(passwordInput);
                if (hash === data.passwordHash) {
                    setIsLocked(false);
                    parseData(data);
                } else {
                    alert('비밀번호가 일치하지 않습니다.');
                }
            };

            const handleClose = () => {
                sessionStorage.removeItem('current_letter');
                window.location.href = 'index.html';
            };


            if (!data) return (
                <Box sx={{ display: 'flex', height: '100vh', alignItems: 'center', justifyContent: 'center' }}>
                    <Typography>로딩 중...</Typography>
                </Box>
            );

            const theme = createTheme({
                typography: {
                    fontFamily: `'Roboto', 'Pretendard', sans-serif`,
                    h6: { fontWeight: 500 },
                    button: { textTransform: 'none', fontWeight: 500 }
                },
                palette: {
                    primary: { main: THEMES.find(t => t.id === data.theme)?.color || '#6750A4' },
                    background: {
                        default: (THEMES.find(t => t.id === data.theme)?.color || '#6750A4') + '08', // 3% tint
                        paper: '#FFFFFF'
                    },
                    text: { primary: '#1D1B20', secondary: '#49454F' },
                },
                components: {
                    MuiCssBaseline: {
                        styleOverrides: `
                            :root {
                                --T_primary: ${THEMES.find(t => t.id === data.theme)?.color || '#6750A4'};
                                --T_background: ${(THEMES.find(t => t.id === data.theme)?.color || '#6750A4')}08;
                                --T_surface: #FFFFFF;
                                --T_surfaceContainer: ${(THEMES.find(t => t.id === data.theme)?.color || '#6750A4')}15;

                                --L_primary: var(--T_primary);
                                --L_container: var(--T_surfaceContainer);
                            }
                            body { background-color: var(--T_background) !important; }
                        `
                    },
                    MuiCard: {
                        styleOverrides: {
                            root: {
                                borderRadius: 24,
                                boxShadow: 'none',
                                backgroundColor: 'var(--L_container)',
                                border: '1px solid var(--G_gray_light)'
                            }
                        }
                    },
                    MuiButton: {
                        styleOverrides: {
                            root: { borderRadius: 20 },
                            contained: { boxShadow: 'none', '&:hover': { boxShadow: '0 1px 2px rgba(0,0,0,0.3)' } },
                            outlined: { borderColor: 'var(--G_gray_light)', color: 'var(--L_primary)' }
                        }
                    },
                    MuiChip: {
                        styleOverrides: {
                            root: { borderRadius: 8, backgroundColor: 'var(--L_container)', color: 'var(--L_primary)' }
                        }
                    }
                }
            });

            const openPopup = () => window.open(window.LetterDB.toUrl(data, 'popup.html'), '_blank', 'width=600,height=800');

            if (isLocked) return (
                <ThemeProvider theme={theme}>
                    <CssBaseline />
                    <Box sx={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', p: 3, bgcolor: 'background.default' }}>
                        <Paper sx={{ p: 4, width: '100%', maxWidth: 360, textAlign: 'center', borderRadius: 6 }}>
                            <span className="material-symbols-rounded" style={{ fontSize: 48, color: theme.palette.primary.main, marginBottom: 16 }}>lock</span>
                            <Typography variant="h6" gutterBottom>편지가 잠겨있습니다</Typography>
                            <Typography variant="body2" color="text.secondary" sx={{ mb: 3 }}>보낸 분이 설정한 비밀번호(4~6자리)를 입력해주세요.</Typography>
                            <TextField
                                type="password"
                                placeholder="숫자 입력"
                                value={passwordInput}
                                onChange={(e) => setPasswordInput(e.target.value)}
                                fullWidth
                                sx={{ mb: 2 }}
                                inputProps={{ maxLength: 6, pattern: '[0-9]*', inputMode: 'numeric' }}
                                onKeyPress={(e) => e.key === 'Enter' && unlock()}
                            />
                            <Button variant="contained" fullWidth onClick={unlock} disableElevation sx={{ height: 48, borderRadius: 24 }}>확인</Button>
                        </Paper>
                    </Box>
                </ThemeProvider>
            );

            return (
                <ThemeProvider theme={theme}>
                    <CssBaseline />
                    <Box sx={{
                        minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center',
                        p: 3, bgcolor: 'background.default'
                    }}>
                        <Stack spacing={2} sx={{ width: '100%', maxWidth: 400 }}>
                            <Card>
                                <Box sx={{ bgcolor: 'primary.main', p: 4, pb: 6, color: '#FFFFFF', position: 'relative', textAlign: 'center' }}>
                                    <Avatar sx={{
                                        width: 80, height: 80, margin: '0 auto',
                                        bgcolor: 'rgba(255, 255, 255, 0.2)', // 테마 배경 대비 투명한 흰색
                                        color: '#FFFFFF', mb: 2
                                    }}>
                                        <span className="material-symbols-rounded" style={{ fontSize: 40 }}>mail</span>
                                    </Avatar>
                                    <Typography variant="headlineSmall" component="h2" sx={{ fontWeight: 400, fontSize: '1.5rem', color: '#FFFFFF' }}>편지가 도착했습니다!</Typography>
                                    <Typography variant="body2" sx={{ opacity: 0.9, mt: 0.5, color: 'rgba(255, 255, 255, 0.8)' }}>
                                        보낸이: {data.senderName ? (
                                            <>
                                                <span style={{ fontWeight: 600 }}>{data.senderName}</span>
                                                {data.senderRole && <span style={{ fontSize: '0.8em', opacity: 0.8 }}>({data.senderRole})</span>}
                                            </>
                                        ) : (
                                            data.messages ? <span style={{ fontWeight: 600 }}>롤링페이퍼 ({JSON.parse(data.messages).length}명)</span> : <span style={{ fontWeight: 600 }}>익명</span>
                                        )}
                                    </Typography>

                                    <IconButton
                                        sx={{ position: 'absolute', top: 8, right: 8, color: 'white' }}
                                        onClick={handleClose}
                                    >
                                        <span className="material-symbols-rounded">close</span>
                                    </IconButton>
                                </Box>

                                <CardContent sx={{ p: 3, pt: 0, mt: -3 }}>
                                    <Paper elevation={0} sx={{
                                        p: 3,
                                        bgcolor: 'background.paper', // 테마 배경색(White) 사용
                                        mb: 3, borderRadius: 4, border: '1px solid', borderColor: 'divider'
                                    }}>
                                        <Typography variant="labelSmall" color="textSecondary" align="left" sx={{ mb: 0.5, display: 'block', textTransform: 'uppercase', fontWeight: 600 }}>제목</Typography>
                                        <Typography variant="titleMedium" align="left" color="onSurface" sx={{ fontWeight: 500, fontSize: '1.2rem' }}>{data.subject || '제목 없음'}</Typography>
                                    </Paper>

                                    <Stack spacing={1.5} sx={{ mb: 3 }}>
                                        <Button
                                            variant="contained" size="large" disableElevation
                                            fullWidth sx={{ height: 56, fontSize: '1rem' }}
                                            onClick={openPopup}
                                            startIcon={<span className="material-symbols-rounded">open_in_new</span>}
                                        >
                                            편지 열기
                                        </Button>

                                        <Stack direction="row" spacing={1}>
                                            <Button
                                                variant="outlined"
                                                fullWidth sx={{ height: 48 }}
                                                onClick={async () => {
                                                    const url = window.LetterDB.toUrl(data, 'view.html');
                                                    try {
                                                        await navigator.clipboard.writeText(url);
                                                        alert('공유 링크가 클립보드에 복사되었습니다.');
                                                    } catch (e) {
                                                        alert('링크 복사에 실패했습니다.');
                                                    }
                                                }}
                                                startIcon={<span className="material-symbols-rounded">content_copy</span>}
                                            >
                                                공유 링크 복사
                                            </Button>
                                            <Button
                                                variant="outlined"
                                                fullWidth sx={{ height: 48 }}
                                                onClick={() => window.open(window.LetterDB.toUrl(data, 'popup.html') + '&mode=print', '_blank')}
                                                startIcon={<span className="material-symbols-rounded">print</span>}
                                            >
                                                편지 인쇄
                                            </Button>
                                        </Stack>
                                    </Stack>

                                    <Divider sx={{ my: 3 }} />

                                    <Stack direction="row" spacing={1} justifyContent="center" sx={{ mb: 1 }}>
                                        {data.phone ? <Button variant="outlined" startIcon={<span className="material-symbols-rounded">call</span>} href={`tel:${data.phone}`} sx={{ flex: 1 }}>전화</Button> : null}
                                        {data.email ? <Button variant="outlined" startIcon={<span className="material-symbols-rounded">email</span>} href={`mailto:${data.email}`} sx={{ flex: 1 }}>이메일</Button> : null}
                                    </Stack>

                                    {data.driveLink && (
                                        <Button fullWidth color="secondary" href={data.driveLink.startsWith('http') ? data.driveLink : `https://${data.driveLink}`} target="_blank" startIcon={<span className="material-symbols-rounded">attach_file</span>} sx={{ mt: 1 }}>
                                            첨부파일 열기
                                        </Button>
                                    )}
                                </CardContent>
                            </Card>

                            <Button color="inherit" onClick={handleClose} sx={{ color: 'text.secondary' }}>
                                받은 편지함으로 이동
                            </Button>
                        </Stack>
                    </Box>
                </ThemeProvider>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>